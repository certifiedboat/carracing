<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Racing Game</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for the game canvas and overall layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent scrolling */
        }
        canvas {
            background-color: #333; /* Road background */
            border-radius: 10px; /* Rounded corners for the game area */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* Subtle shadow */
            display: block; /* Remove extra space below canvas */
            touch-action: none; /* Prevent default touch actions like scrolling/zooming */
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px; /* Space between elements */
            padding: 20px;
        }
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%; /* Take full width of parent */
            max-width: 400px; /* Match canvas width */
            color: #e2e8f0; /* Light text color */
            font-size: 1.25rem; /* Larger font size */
            font-weight: bold;
        }
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9); /* Darker overlay */
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none; /* Hidden by default */
            border: 2px solid #4a5568;
            max-width: 90%; /* Responsive width */
        }
        .message-box h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #f6ad55; /* Orange color for heading */
        }
        .message-box p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        .button-primary {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6); /* Gradient background */
            color: white;
            padding: 15px 30px;
            border-radius: 9999px; /* Fully rounded */
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            outline: none; /* Remove outline on focus */
            margin-top: 10px;
        }
        .button-primary:hover {
            transform: translateY(-3px); /* Lift effect on hover */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .button-primary:active {
            transform: translateY(1px); /* Press effect on click */
        }

        /* Responsive controls for mobile */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            max-width: 400px;
        }

        .control-button {
            background-color: #4a5568; /* Darker grey */
            color: white;
            padding: 20px;
            border-radius: 50%; /* Circular buttons */
            font-size: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80px;
            height: 80px;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
            transition: background-color 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .control-button:active {
            background-color: #2d3748; /* Even darker on press */
            transform: scale(0.95);
        }

        /* Hide controls on larger screens */
        @media (min-width: 768px) {
            .controls {
                display: none;
            }
        }

        /* Leaderboard styles */
        .leaderboard-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none; /* Hidden by default */
            border: 2px solid #4a5568;
            max-width: 90%;
            width: 400px;
        }
        .leaderboard-container h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #f6ad55;
        }
        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .leaderboard-list li {
            padding: 10px 15px;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
        }
        .leaderboard-list li:last-child {
            border-bottom: none;
        }
        .leaderboard-list li:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Car Customization / Shop styles */
        .shop-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none; /* Hidden by default */
            border: 2px solid #4a5568;
            max-width: 90%;
            width: 400px;
        }
        .shop-container h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #f6ad55;
        }
        .color-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .color-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .color-button:hover {
            transform: scale(1.05);
        }
        .color-button.selected {
            border-color: #f6ad55; /* Highlight selected color */
            transform: scale(1.1);
        }
        .color-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        .color-button span {
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-info">
            <div id="scoreDisplay">Score: 0</div>
            <div id="speedDisplay">Speed: 0 km/h</div>
            <div id="coinsDisplay">Coins: 0</div>
        </div>
        <canvas id="gameCanvas"></canvas>

        <!-- Mobile Controls -->
        <div class="controls">
            <button id="leftButton" class="control-button">◀</button>
            <button id="rightButton" class="control-button">▶</button>
        </div>

        <!-- Message Box (Game Over/Start) -->
        <div id="messageBox" class="message-box">
            <h2 id="messageTitle">Car Racing Game</h2>
            <p id="messageText">Enter your name and press 'Start Game'!</p>
            <input type="text" id="playerNameInput" placeholder="Enter your name" class="p-3 mb-4 rounded-lg bg-gray-700 text-white w-full max-w-xs text-center text-lg outline-none focus:ring-2 focus:ring-purple-500" maxlength="15">
            <button id="startButton" class="button-primary">Start Game</button>
            <button id="leaderboardButton" class="button-primary mt-4">Leaderboard</button>
            <button id="customizeCarButton" class="button-primary mt-4">Customize Car</button>
        </div>

        <!-- Leaderboard Container -->
        <div id="leaderboardContainer" class="leaderboard-container">
            <h2>Leaderboard</h2>
            <ul id="leaderboardList" class="leaderboard-list">
                <!-- Leaderboard items will be inserted here by JS -->
            </ul>
            <button id="closeLeaderboardButton" class="button-primary">Close</button>
        </div>

        <!-- Car Customization / Shop Container -->
        <div id="shopContainer" class="shop-container">
            <h2>Customize Your Car</h2>
            <p class="text-xl mb-4">Your Coins: <span id="shopCoinsDisplay">0</span></p>
            <div id="colorOptions" class="color-options">
                <!-- Color buttons will be inserted here by JS -->
            </div>
            <button id="closeShopButton" class="button-primary">Close</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Get canvas and its 2D rendering context
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Get UI elements
        const scoreDisplay = document.getElementById('scoreDisplay');
        const speedDisplay = document.getElementById('speedDisplay');
        const coinsDisplay = document.getElementById('coinsDisplay');
        const messageBox = document.getElementById('messageBox');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const playerNameInput = document.getElementById('playerNameInput');
        const startButton = document.getElementById('startButton');
        const leaderboardButton = document.getElementById('leaderboardButton');
        const customizeCarButton = document.getElementById('customizeCarButton');

        // Mobile control buttons
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');

        // Leaderboard elements
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const leaderboardList = document.getElementById('leaderboardList');
        const closeLeaderboardButton = document.getElementById('closeLeaderboardButton');

        // Shop elements
        const shopContainer = document.getElementById('shopContainer');
        const shopCoinsDisplay = document.getElementById('shopCoinsDisplay');
        const colorOptions = document.getElementById('colorOptions');
        const closeShopButton = document.getElementById('closeShopButton');

        // Game settings
        const GAME_WIDTH = 400;
        const GAME_HEIGHT = 600;
        const LANE_WIDTH = GAME_WIDTH / 3; // Three lanes
        const ROAD_COLOR = '#444';
        const LANE_LINE_COLOR = '#eee';
        const LANE_LINE_DASH = [20, 20]; // Dash pattern for lane lines

        // Player car settings
        const PLAYER_CAR_WIDTH = 40;
        const PLAYER_CAR_HEIGHT = 80;
        const DEFAULT_PLAYER_CAR_COLOR = '#3b82f6'; // Blue color
        let playerCar = {
            x: GAME_WIDTH / 2 - PLAYER_CAR_WIDTH / 2, // Start in middle lane
            y: GAME_HEIGHT - PLAYER_CAR_HEIGHT - 50, // Near bottom
            width: PLAYER_CAR_WIDTH,
            height: PLAYER_CAR_HEIGHT,
            speedX: 0, // Horizontal speed
            maxSpeedX: 5, // Max horizontal speed
            lane: 1, // 0: left, 1: middle, 2: right
            color: DEFAULT_PLAYER_CAR_COLOR // Initial color
        };

        // Game state variables
        let gameSpeed = 5; // Initial game speed (how fast objects move down)
        let score = 0;
        let coins = 0;
        let highScore = 0;
        let playerName = "Guest";
        let selectedCarColor = DEFAULT_PLAYER_CAR_COLOR;
        let gameOver = true;
        let opponentCars = [];
        let lastOpponentTime = 0;
        const OPPONENT_SPAWN_INTERVAL = 1000; // Milliseconds between opponent spawns
        const OPPONENT_CAR_WIDTH = 40;
        const OPPONENT_CAR_HEIGHT = 80;
        const OPPONENT_COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#ec4899']; // Red, Orange, Yellow, Green, Pink

        // Car colors available for purchase
        const CAR_COLORS = [
            { name: 'Blue', hex: '#3b82f6', cost: 0 }, // Default, free
            { name: 'Red', hex: '#ef4444', cost: 50 },
            { name: 'Green', hex: '#22c55e', cost: 75 },
            { name: 'Purple', hex: '#8b5cf6', cost: 100 },
            { name: 'Yellow', hex: '#eab308', cost: 120 },
            { name: 'Pink', hex: '#ec4899', cost: 150 }
        ];

        // Keyboard input
        let keys = {};

        // Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous

        // --- Firebase Initialization and Authentication ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase authenticated. User ID:", userId);
                    await loadPlayerData(); // Load player data once authenticated
                    listenToLeaderboard(); // Start listening to leaderboard
                    // If game is not running, show message box with player name
                    if (gameOver) {
                        playerNameInput.value = playerName;
                        messageBox.style.display = 'block';
                    }
                } else {
                    console.log("No user signed in, attempting anonymous sign-in.");
                    try {
                        const __initial_auth_token = typeof window !== 'undefined' && window.__initial_auth_token;
                        if (__initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        // The onAuthStateChanged listener will be triggered again with the signed-in user
                    } catch (error) {
                        console.error("Firebase anonymous sign-in failed:", error);
                        messageText.textContent = "Error loading game. Please try again.";
                        messageBox.style.display = 'block';
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            messageTitle.textContent = "Error";
            messageText.textContent = "Failed to initialize game services. Please check your connection.";
            messageBox.style.display = 'block';
        }

        // --- Firestore Data Operations ---

        // Get player data document reference
        function getPlayerDocRef() {
            return doc(db, `artifacts/${appId}/users/${userId}/playerData/profile`);
        }

        // Get leaderboard collection reference
        function getLeaderboardCollectionRef() {
            return collection(db, `artifacts/${appId}/public/data/leaderboard`);
        }

        // Load player data from Firestore
        async function loadPlayerData() {
            // Ensure Firebase user is available before attempting to load data
            if (!auth.currentUser) {
                console.log("Firebase user not available, skipping loadPlayerData.");
                return;
            }
            try {
                const playerDoc = await getDoc(getPlayerDocRef());
                if (playerDoc.exists()) {
                    const data = playerDoc.data();
                    playerName = data.name || "Guest";
                    coins = data.coins || 0;
                    highScore = data.highScore || 0;
                    selectedCarColor = data.selectedCarColor || DEFAULT_PLAYER_CAR_COLOR;
                    playerCar.color = selectedCarColor; // Apply loaded color to game car
                    console.log("Player data loaded:", data);
                } else {
                    // Create initial player data if it doesn't exist
                    await setDoc(getPlayerDocRef(), {
                        name: "Guest",
                        coins: 0,
                        highScore: 0,
                        selectedCarColor: DEFAULT_PLAYER_CAR_COLOR
                    });
                    playerName = "Guest";
                    coins = 0;
                    highScore = 0;
                    selectedCarColor = DEFAULT_PLAYER_CAR_COLOR;
                    playerCar.color = selectedCarColor;
                    console.log("New player profile created.");
                }
                updatePlayerUI(); // Update UI after loading data
            } catch (error) {
                console.error("Error loading player data:", error);
            }
        }

        // Save player data to Firestore
        async function savePlayerData() {
            // Ensure Firebase user is available before attempting to save data
            if (!auth.currentUser) {
                console.log("Firebase user not available, skipping savePlayerData.");
                return;
            }
            try {
                await setDoc(getPlayerDocRef(), {
                    name: playerName,
                    coins: coins,
                    highScore: highScore,
                    selectedCarColor: selectedCarColor
                }, { merge: true }); // Use merge to only update specified fields
                console.log("Player data saved.");
            } catch (error) {
                console.error("Error saving player data:", error);
            }
        }

        // Update leaderboard in Firestore
        async function updateLeaderboard(newScore) {
            // Ensure Firebase user is available before attempting to update leaderboard
            if (!auth.currentUser) {
                console.log("Firebase user not available, skipping updateLeaderboard.");
                return;
            }
            try {
                // Add a new score entry to the leaderboard collection
                await addDoc(getLeaderboardCollectionRef(), {
                    name: playerName,
                    score: newScore,
                    timestamp: new Date() // Use timestamp for potential secondary sorting if scores are equal
                });
                console.log("Leaderboard updated with new score:", newScore);
            } catch (error) {
                console.error("Error updating leaderboard:", error);
            }
        }

        // Listen to real-time updates for leaderboard
        function listenToLeaderboard() {
            // Ensure Firebase user is available before attempting to listen
            if (!auth.currentUser) {
                console.log("Firebase user not available, skipping listenToLeaderboard.");
                return;
            }
            // Fetch all documents in the leaderboard collection
            const q = collection(db, `artifacts/${appId}/public/data/leaderboard`);
            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });
                // Sort scores in memory (descending by score, then ascending by timestamp for ties)
                scores.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    // If scores are equal, sort by timestamp (earlier timestamp first)
                    return a.timestamp.toDate().getTime() - b.timestamp.toDate().getTime();
                });
                // Take top 10 scores
                renderLeaderboard(scores.slice(0, 10));
            }, (error) => {
                console.error("Error listening to leaderboard:", error);
            });
        }

        // --- UI Update Functions ---

        function updatePlayerUI() {
            coinsDisplay.textContent = `Coins: ${coins}`;
            shopCoinsDisplay.textContent = coins;
            // Update the selected car color in the game
            playerCar.color = selectedCarColor;
            // Update the input field with the current player name
            playerNameInput.value = playerName;
            // Highlight the currently selected color in the shop
            renderColorOptions();
        }

        function renderLeaderboard(scores) {
            leaderboardList.innerHTML = ''; // Clear previous list
            if (scores.length === 0) {
                leaderboardList.innerHTML = '<li class="text-center py-4">No scores yet. Be the first!</li>';
                return;
            }
            scores.forEach((entry, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${index + 1}. ${entry.name}</span><span>${entry.score}</span>`;
                leaderboardList.appendChild(li);
            });
        }

        function renderColorOptions() {
            colorOptions.innerHTML = ''; // Clear previous options
            CAR_COLORS.forEach(color => {
                const button = document.createElement('button');
                button.className = `color-button ${selectedCarColor === color.hex ? 'selected' : ''} ${coins < color.cost && color.cost > 0 ? 'disabled' : ''}`;
                button.style.backgroundColor = color.hex;
                button.innerHTML = `<span>${color.cost > 0 ? `${color.cost}C` : 'FREE'}</span>`;
                button.onclick = () => purchaseColor(color);
                colorOptions.appendChild(button);
            });
        }

        function purchaseColor(color) {
            if (selectedCarColor === color.hex) {
                console.log("Color already selected.");
                showMessage("Color Already Selected", "This color is already your car's color!");
                return;
            }
            if (coins >= color.cost) {
                coins -= color.cost;
                selectedCarColor = color.hex;
                playerCar.color = selectedCarColor; // Update car color immediately
                savePlayerData(); // Save new coin balance and selected color
                updatePlayerUI(); // Update coin display and shop buttons
                console.log(`Purchased ${color.name} for ${color.cost} coins.`);
                showMessage("Success!", `You purchased ${color.name}!`);
            } else {
                console.log("Not enough coins to purchase this color.");
                showMessage("Not Enough Coins!", `You need ${color.cost - coins} more coins for ${color.name}.`);
            }
        }

        // --- Game Core Logic ---

        // Adjust canvas size for responsiveness
        function resizeCanvas() {
            const aspectRatio = GAME_WIDTH / GAME_HEIGHT;
            let newWidth = window.innerWidth * 0.9; // 90% of window width
            let newHeight = newWidth / aspectRatio;

            if (newHeight > window.innerHeight * 0.8) { // If too tall, adjust based on height
                newHeight = window.innerHeight * 0.8;
                newWidth = newHeight * aspectRatio;
            }

            canvas.width = GAME_WIDTH; // Internal drawing resolution
            canvas.height = GAME_HEIGHT;

            // Scale the canvas element itself using CSS for visual display
            canvas.style.width = `${newWidth}px`;
            canvas.style.height = `${newHeight}px`;
        }

        // Initialize canvas size on load and resize
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);

        // Event listeners for keyboard input
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Event listeners for mobile controls
        leftButton.addEventListener('touchstart', (e) => { e.preventDefault(); keys['ArrowLeft'] = true; });
        leftButton.addEventListener('touchend', (e) => { e.preventDefault(); keys['ArrowLeft'] = false; });
        rightButton.addEventListener('touchstart', (e) => { e.preventDefault(); keys['ArrowRight'] = true; });
        rightButton.addEventListener('touchend', (e) => { e.preventDefault(); keys['ArrowRight'] = false; });

        // Game loop
        function gameLoop(currentTime) {
            if (gameOver) {
                return; // Stop the loop if game is over
            }

            update(currentTime);
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Update game state
        function update(currentTime) {
            // Update player car position based on input
            if (keys['ArrowLeft'] || keys['a']) {
                playerCar.x -= playerCar.maxSpeedX;
            }
            if (keys['ArrowRight'] || keys['d']) {
                playerCar.x += playerCar.maxSpeedX;
            }

            // Keep player car within road boundaries
            playerCar.x = Math.max(0, Math.min(GAME_WIDTH - playerCar.width, playerCar.x));

            // Spawn opponent cars
            if (currentTime - lastOpponentTime > OPPONENT_SPAWN_INTERVAL / (gameSpeed / 5)) { // Faster spawn at higher speeds
                spawnOpponentCar();
                lastOpponentTime = currentTime;
            }

            // Move and update opponent cars
            opponentCars.forEach((car, index) => {
                car.y += gameSpeed; // Move down

                // Remove cars that go off-screen
                if (car.y > GAME_HEIGHT) {
                    opponentCars.splice(index, 1);
                    score++; // Increment score for each car passed
                    coins += 1; // Earn 1 coin per car passed
                    coinsDisplay.textContent = `Coins: ${coins}`; // Update coins display immediately
                }

                // Collision detection with player car
                if (checkCollision(playerCar, car)) {
                    endGame();
                }
            });

            // Increase game speed gradually
            gameSpeed += 0.001; // Small increment per frame

            // Update UI
            scoreDisplay.textContent = `Score: ${score}`;
            speedDisplay.textContent = `Speed: ${Math.floor(gameSpeed * 10)} km/h`; // Scale speed for display
        }

        // Draw game elements
        function draw() {
            // Clear canvas
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            // Draw road
            ctx.fillStyle = ROAD_COLOR;
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            // Draw lane lines
            ctx.strokeStyle = LANE_LINE_COLOR;
            ctx.lineWidth = 5;
            ctx.setLineDash(LANE_LINE_DASH);

            // Animate lane lines to move down
            // This creates the illusion of movement
            const lineDashOffset = (performance.now() * 0.05) % (LANE_LINE_DASH[0] + LANE_LINE_DASH[1]);
            ctx.lineDashOffset = -lineDashOffset;

            // Left lane line
            ctx.beginPath();
            ctx.moveTo(LANE_WIDTH, 0);
            ctx.lineTo(LANE_WIDTH, GAME_HEIGHT);
            ctx.stroke();

            // Right lane line
            ctx.beginPath();
            ctx.moveTo(LANE_WIDTH * 2, 0);
            ctx.lineTo(LANE_WIDTH * 2, GAME_HEIGHT);
            ctx.stroke();

            ctx.setLineDash([]); // Reset line dash for other drawings
            ctx.lineDashOffset = 0; // Reset offset

            // Draw player car
            drawCar(playerCar.x, playerCar.y, playerCar.width, playerCar.height, playerCar.color);

            // Draw opponent cars
            opponentCars.forEach(car => {
                drawCar(car.x, car.y, car.width, car.height, car.color);
            });
        }

        // Helper function to draw a car (more detailed shape)
        function drawCar(x, y, width, height, color) {
            ctx.fillStyle = color;

            // Main body
            ctx.beginPath();
            ctx.moveTo(x + width * 0.1, y); // Top-left corner (slightly rounded)
            ctx.lineTo(x + width * 0.9, y); // Top-right corner
            ctx.lineTo(x + width, y + height * 0.9); // Bottom-right corner
            ctx.lineTo(x, y + height * 0.9); // Bottom-left corner
            ctx.closePath();
            ctx.fill();

            // Roof/Cabin
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'; // Lighter color for window
            ctx.beginPath();
            ctx.moveTo(x + width * 0.2, y + height * 0.15);
            ctx.lineTo(x + width * 0.8, y + height * 0.15);
            ctx.lineTo(x + width * 0.7, y + height * 0.4);
            ctx.lineTo(x + width * 0.3, y + height * 0.4);
            ctx.closePath();
            ctx.fill();

            // Wheels (dark grey circles)
            ctx.fillStyle = '#333';
            const wheelRadius = width * 0.15;
            // Front left wheel
            ctx.beginPath();
            ctx.arc(x + width * 0.15, y + height * 0.25, wheelRadius, 0, Math.PI * 2);
            ctx.fill();
            // Front right wheel
            ctx.beginPath();
            ctx.arc(x + width * 0.85, y + height * 0.25, wheelRadius, 0, Math.PI * 2);
            ctx.fill();
            // Rear left wheel
            ctx.beginPath();
            ctx.arc(x + width * 0.15, y + height * 0.75, wheelRadius, 0, Math.PI * 2);
            ctx.fill();
            // Rear right wheel
            ctx.beginPath();
            ctx.arc(x + width * 0.85, y + height * 0.75, wheelRadius, 0, Math.PI * 2);
            ctx.fill();
        }

        // Spawn a new opponent car
        function spawnOpponentCar() {
            const lane = Math.floor(Math.random() * 3); // Random lane (0, 1, or 2)
            const x = lane * LANE_WIDTH + (LANE_WIDTH - OPPONENT_CAR_WIDTH) / 2;
            const color = OPPONENT_COLORS[Math.floor(Math.random() * OPPONENT_COLORS.length)];
            opponentCars.push({
                x: x,
                y: -OPPONENT_CAR_HEIGHT, // Start above the screen
                width: OPPONENT_CAR_WIDTH,
                height: OPPONENT_CAR_HEIGHT,
                color: color
            });
        }

        // Check for collision between two rectangles
        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }

        // End the game
        function endGame() {
            gameOver = true;
            messageTitle.textContent = 'Game Over!';
            messageText.textContent = `You scored: ${score} points. Your High Score: ${highScore} points.`;
            startButton.textContent = 'Play Again';
            messageBox.style.display = 'block'; // Show game over message

            if (score > highScore) {
                highScore = score;
                savePlayerData(); // Save new high score
                updateLeaderboard(highScore); // Update leaderboard
            }
            savePlayerData(); // Always save coins and current name
        }

        // Start/Restart game
        function startGame() {
            const enteredName = playerNameInput.value.trim();
            if (enteredName) {
                playerName = enteredName;
            } else {
                playerName = "Guest"; // Fallback if name is empty
            }
            savePlayerData(); // Save the entered name

            gameOver = false;
            score = 0;
            gameSpeed = 5;
            playerCar.x = GAME_WIDTH / 2 - PLAYER_CAR_WIDTH / 2; // Reset player position
            opponentCars = []; // Clear opponent cars
            lastOpponentTime = performance.now(); // Reset timer for opponent spawning
            messageBox.style.display = 'none'; // Hide message box
            leaderboardContainer.style.display = 'none'; // Hide leaderboard
            shopContainer.style.display = 'none'; // Hide shop

            // Reset UI displays
            scoreDisplay.textContent = `Score: ${score}`;
            speedDisplay.textContent = `Speed: ${Math.floor(gameSpeed * 10)} km/h`;
            coinsDisplay.textContent = `Coins: ${coins}`;

            requestAnimationFrame(gameLoop); // Start the game loop
        }

        // Helper function to show a temporary message box
        function showMessage(title, text) {
            const tempMessageBox = document.createElement('div');
            tempMessageBox.className = 'message-box';
            tempMessageBox.style.display = 'block';
            tempMessageBox.style.opacity = '0';
            tempMessageBox.style.transition = 'opacity 0.5s ease-in-out';
            tempMessageBox.innerHTML = `<h2>${title}</h2><p>${text}</p>`;
            document.body.appendChild(tempMessageBox);

            setTimeout(() => {
                tempMessageBox.style.opacity = '1';
            }, 10); // Small delay to trigger transition

            setTimeout(() => {
                tempMessageBox.style.opacity = '0';
                tempMessageBox.addEventListener('transitionend', () => {
                    tempMessageBox.remove();
                });
            }, 2000); // Message visible for 2 seconds
        }

        // --- Event Listeners for UI Buttons ---
        startButton.addEventListener('click', startGame);

        leaderboardButton.addEventListener('click', () => {
            messageBox.style.display = 'none';
            shopContainer.style.display = 'none';
            leaderboardContainer.style.display = 'block';
        });

        closeLeaderboardButton.addEventListener('click', () => {
            leaderboardContainer.style.display = 'none';
            messageBox.style.display = 'block'; // Go back to main menu
        });

        customizeCarButton.addEventListener('click', () => {
            messageBox.style.display = 'none';
            leaderboardContainer.style.display = 'none';
            shopContainer.style.display = 'block';
            updatePlayerUI(); // Refresh coins and color options in shop
        });

        closeShopButton.addEventListener('click', () => {
            shopContainer.style.display = 'none';
            messageBox.style.display = 'block'; // Go back to main menu
        });

        // Show initial message box when the page loads
        window.onload = function() {
            resizeCanvas(); // Ensure canvas is sized correctly on load
            // Firebase auth listener will handle showing messageBox after loading data
        };
    </script>
</body>
</html>
